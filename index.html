<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>예배당 사제 계산기 · 펀치킹 DPS</title>
<style>
  :root{
    --bg:#0a0c12; --bg2:#0d111a; --card:#111624; --text:#eaf2ff; --muted:#9fb0c9; --border:#1b2436;
    --accent:#7fb3ff; --accent2:#a07bff; --good:#73e0a9; --warn:#ffd36b; --bad:#ff7b7b;
    --chip:#0f1422; --chipBorder:#1c2740;
    --radius-lg:22px; --radius-md:16px; --radius-sm:12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:
      radial-gradient(80% 60% at 80% -10%, rgba(160,123,255,.25), transparent 65%),
      radial-gradient(80% 60% at 10% -10%, rgba(127,179,255,.25), transparent 65%),
      linear-gradient(180deg, var(--bg), var(--bg2) 60%, var(--bg));
    color:var(--text); font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Pretendard,Segoe UI,Roboto;
  }
  .wrap{max-width:1180px; margin:28px auto 60px; padding:0 18px}
  /* HERO */
  .hero{
    position:relative; border-radius:var(--radius-lg);
    padding:22px 20px; background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
    border:1px solid var(--border); box-shadow:0 10px 40px rgba(0,0,0,.3), inset 0 0 60px rgba(127,179,255,.06);
    overflow:hidden;
  }
  .hero h1{margin:0 0 4px; font-size:18px; color:var(--muted); font-weight:600}
  .score{
    font-size:44px; font-weight:900; letter-spacing:.2px; line-height:1.1;
    background:linear-gradient(90deg, #7fb3ff, #a07bff, #73e0a9, #ffd36b, #7fb3ff);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    background-size:300% 100%; animation:shine 7s linear infinite;
    text-shadow: 0 6px 40px rgba(160,123,255,.25);
  }
  @keyframes shine{0%{background-position:0% 0}100%{background-position:100% 0}}

  /* confetti */
  .spark{position:absolute; inset:0; pointer-events:none}
  .spark i{
    position:absolute; width:6px; height:6px; border-radius:50%;
    background:linear-gradient(180deg,#a07bff,#7fb3ff);
    opacity:.8; filter:blur(.2px);
    animation:drop 3.6s infinite ease-in;
  }
  @keyframes drop{
    0%{transform:translateY(-20px) scale(.8); opacity:.0}
    15%{opacity:1}
    100%{transform:translateY(240px) scale(1.1); opacity:0}
  }

  .grid{display:grid; grid-template-columns:1.1fr .9fr; gap:16px; margin-top:16px}
  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.015));
    border:1px solid var(--border); border-radius:var(--radius-md); padding:16px;
    box-shadow:0 8px 30px rgba(0,0,0,.25);
  }
  .card h3{margin:0 0 12px; font-size:16px; color:#cfe0ff}

  .row{display:flex; gap:10px; align-items:center; margin:10px 0}
  label{min-width:180px; color:#cfe0ff; font-weight:600}
  select,input{
    width:100%; background:var(--chip); border:1px solid var(--chipBorder); color:var(--text);
    padding:10px 12px; border-radius:14px; outline:none;
    box-shadow:inset 0 1px 0 rgba(255,255,255,.04);
  }

  /* KPI */
  .kpi{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:12px}
  .kbox{
    background:#0f1422; border:1px solid var(--chipBorder); border-radius:18px; padding:14px;
    box-shadow:0 6px 20px rgba(0,0,0,.18);
  }
  .kbox .t{color:var(--muted); font-size:12px; margin-bottom:6px}
  .kbox .v{font-size:20px; font-weight:800; letter-spacing:.2px}

  /* Settings chips */
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{
    display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px;
    background:var(--chip); border:1px solid var(--chipBorder); font-size:13px; color:#cfe0ff; cursor:pointer;
    user-select:none;
  }
  .chip input{accent-color:#7fb3ff}
  .hint{color:var(--muted); font-size:12px; margin-top:6px}

  /* Gems table */
  table{width:100%; border-collapse:separate; border-spacing:0}
  thead th{
    position:sticky; top:0; background:#0f1422; color:#cfe0ff;
    padding:10px; border-bottom:1px solid var(--border);
  }
  tbody td{padding:8px 10px; border-bottom:1px solid var(--border)}
  .footer{margin-top:20px; color:var(--muted); font-size:12px}

  @media (max-width:980px){
    .grid{grid-template-columns:1fr; gap:12px}
    .kpi{grid-template-columns:1fr 1fr}
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- HERO: 펀치킹 DPS -->
  <section class="hero">
    <h1>최종 펀치킹 DPS 점수</h1>
    <div id="punchScore" class="score">-</div>
    <div class="spark" aria-hidden="true"></div>
  </section>

  <section class="grid">
    <!-- 좌: 입력 -->
    <div class="card">
      <h3>입력 (라벨 한글화)</h3>
      <div class="row">
        <label for="X6">강타 적용</label>
        <select id="X6"><option>O</option><option selected>X</option></select>
      </div>
      <div class="row">
        <label for="F8">헬리오도르 보유</label>
        <select id="F8"><option selected>O</option><option>X</option></select>
      </div>
      <div class="row">
        <label for="M8">추가 보정(M8)</label>
        <select id="M8"><option>X</option><option>O</option></select>
      </div>

      <div class="row">
        <label for="AJ31">DPS 모드</label>
        <select id="AJ31">
          <option selected>글라리 전용 DPS</option>
          <option>다른 레이드 DPS</option>
        </select>
      </div>

      <div class="row">
        <label for="T25">특성</label>
        <select id="T25">
          <option>현란함</option><option>지혜로움</option><option>여신의 권능</option><option>여신의 가호</option>
          <option>강렬함</option><option>날쌤</option><option>냉혹함</option><option>굳건함</option><option>광폭함</option>
        </select>
      </div>

      <div class="row">
        <label for="T22">룬 1</label>
        <select id="T22">
          <option>빛줄기</option><option>성전</option><option>수레바퀴</option><option>결속</option><option>날개</option><option>희생</option><option>기타 룬</option>
        </select>
      </div>
      <div class="row">
        <label for="T23">룬 2</label>
        <select id="T23">
          <option>빛줄기</option><option>성전</option><option>수레바퀴</option><option>결속</option><option>날개</option><option>희생</option><option>기타 룬</option>
        </select>
      </div>
      <div class="row">
        <label for="T24">룬 3</label>
        <select id="T24">
          <option>빛줄기</option><option>성전</option><option>수레바퀴</option><option>결속</option><option>날개</option><option>희생</option><option>기타 룬</option>
        </select>
      </div>

      <div class="row">
        <label for="T37">무기 등급</label>
        <select id="T37">
          <option>전설 블랙탄</option><option>전설 갈포메</option><option>에픽 블랙탄</option><option>에픽 갈포메</option><option selected>기타</option>
        </select>
      </div>
      <div class="row">
        <label for="T38">반사신경</label>
        <select id="T38">
          <option selected>없음</option>
          <option>신속태그 반사신경 1개</option><option>신속태그 반사신경 2개</option><option>신속태그 반사신경 3개</option>
          <option>다른태그 반사신경 1개</option><option>다른태그 반사신경 2개</option><option>다른태그 반사신경 3개</option>
        </select>
      </div>

      <div class="row">
        <label for="T35">레벨업 카드 공격력</label>
        <input id="T35" type="number" step="1" value="600" />
      </div>
      <div class="row">
        <label for="T36">무기 각인 공격력</label>
        <input id="T36" type="number" step="1" value="375" />
      </div>
      <div class="row">
        <label for="AB37">펫 공격력</label>
        <input id="AB37" type="number" step="0.1" value="1595.5" />
      </div>

      <div class="hint">※ 아래 보석 테이블에서 0~3을 선택하세요 (0=없음, 1/2/3=등급).</div>
    </div>

    <!-- 우: 출력 & 카드 선택 -->
    <div class="card">
      <h3>출력 카드</h3>
      <div class="chips" id="cardChips"></div>
      <div class="hint">표시할 카드를 선택/해제하면 바로 반영됩니다(브라우저에 저장).</div>

      <div class="kpi" id="kpiGrid" style="margin-top:12px"></div>
    </div>
  </section>

  <section class="card" style="margin-top:16px">
    <h3>보석 체크리스트 (D~M 열)</h3>
    <div class="hint">열 의미: <b>D,E,F,G,M</b>=뎀증 / <b>H,I,J,K,L</b>=쿨감</div>
    <div style="overflow:auto; max-height:48vh">
      <table>
        <thead>
          <tr><th>부위</th><th>D(뎀증)</th><th>E(뎀증)</th><th>F(뎀증)</th><th>G(뎀증)</th><th>H(쿨감)</th><th>I(쿨감)</th><th>J(쿨감)</th><th>K(쿨감)</th><th>L(쿨감)</th><th>M(뎀증)</th></tr>
        </thead>
        <tbody id="gemBody"></tbody>
      </table>
    </div>
  </section>

  <div class="footer">
    ⓘ 계산 로직: SUMPRODUCT 가중합(보석), 반사신경에 따른 유효 쿨다운, 룬/헬리오도르 보정, <b>펀치킹 DPS=기본대미지(보정 후) × 초당타수</b>.<br/>
    엑셀의 세부 LAMBDA/수식 원문을 주시면 동일식으로 즉시 교체 가능합니다.
  </div>
</div>

<script>
/* --------------------- 데이터/상수 --------------------- */
const W_DMG = {1:2.0, 2:1.7, 3:1.5};        // 뎀증 가중치
const W_CDR = {1:0.65, 2:0.55, 3:0.45};     // 쿨감 가중치

const BASE_COOLDOWNS = { // BC7~13 개념: 샘플 값
  7:40, 8:32, 9:34, 10:28, 11:34, 12:30, 13:26
};
const REFLEX_CDR = {
  "없음":0,
  "신속태그 반사신경 1개":0.10, "신속태그 반사신경 2개":0.20, "신속태그 반사신경 3개":0.30,
  "다른태그 반사신경 1개":0.08, "다른태그 반사신경 2개":0.16, "다른태그 반사신경 3개":0.24
};
const DPS_MODE = { // AV26/AV30 개념의 가중
  "글라리 전용 DPS": {weightA:7,   weightB:3},
  "다른 레이드 DPS": {weightA:3.3, weightB:2.3}
};

// 부위 라벨(라벨 한글화). 필요시 원하는 명칭으로 바꿔 쓰세요.
const GEM_LABELS = [
  "부위 12","부위 13","부위 14","부위 15","부위 16","부위 17","부위 18","부위 19","부위 20","부위 21","부위 22",
  "부위 23","부위 24","부위 25","부위 26","부위 27","부위 28","부위 29","부위 30","부위 31","부위 32","부위 33"
];

/* --------------------- 유틸/엑셀 유사 --------------------- */
const sum = a => a.reduce((s,v)=>s+(+v||0),0);
const avg = a => a.length ? sum(a)/a.length : 0;
function includesCaseInsensitive(hay, needle){
  return String(hay||"").toLowerCase().includes(String(needle||"").toLowerCase());
}
function sumproductWeights(values, weights){
  let s=0; for(const v of values){ if(weights[v]) s+=weights[v]; } return s;
}
function hitsPerSecondFromCooldowns(cooldowns, hitWeights){
  const w = (hitWeights?.weightA ?? 1) + (hitWeights?.weightB ?? 0);
  let rate = 0; for(const cd of cooldowns){ if(cd && cd>0) rate += (1/cd) * w; }
  return rate;
}
function CALCULATE_DPS(baseDamage, cooldowns, modeName){
  const modeW = DPS_MODE[modeName] || DPS_MODE["글라리 전용 DPS"];
  const hps = hitsPerSecondFromCooldowns(cooldowns, modeW);
  return baseDamage * hps;
}

/* --------------------- 보석 테이블 렌더 --------------------- */
const gemBody = document.getElementById('gemBody');
(function renderGem(){
  for(let idx=0, r=12; r<=33; r++, idx++){
    const tr=document.createElement('tr');
    const labelTd=document.createElement('td'); labelTd.textContent = GEM_LABELS[idx]||`부위 ${r}`; tr.appendChild(labelTd);
    for(let c=0;c<11;c++){
      const td=document.createElement('td');
      const sel=document.createElement('select');
      [0,1,2,3].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
      sel.value = 0; sel.dataset.addr=`gem_${r}_${c}`; sel.addEventListener('input', recalc);
      td.appendChild(sel); tr.appendChild(td);
    }
    gemBody.appendChild(tr);
  }
})();

/* --------------------- 입력값 수집 --------------------- */
const gv = id => document.getElementById(id).value;
const gn = id => parseFloat(document.getElementById(id).value)||0;
function collectGemCol(colIdx){ // 0..10 (D..M)
  const arr=[]; gemBody.querySelectorAll(`select[data-addr$="_${colIdx}"]`).forEach(sel=>arr.push(parseInt(sel.value,10)||0)); return arr;
}

/* --------------------- 출력 카드 구성 & 토글 --------------------- */
const CARD_DEFS = [
  { id:"totalDmg", name:"총 뎀증 합(%)",            getter: s => (s.D35+s.E35+s.F35+s.G35+s.M35).toFixed(2)+" %" },
  { id:"totalCdr", name:"총 쿨감 합(%)",            getter: s => (s.H35+s.I35+s.J35+s.K35+s.L35).toFixed(2)+" %" },
  { id:"av6",      name:"헬리오도르 보정(AV6)",     getter: s => (s.AV6*100).toFixed(1)+" %" },
  { id:"av7",      name:"룬 보정(AV7)",             getter: s => (s.AV7*100).toFixed(0)+" %" },
  { id:"avgCd",    name:"유효 쿨다운 평균(초)",      getter: s => s.avgCd.toFixed(2)+" s" },
  { id:"hps",      name:"초당 타수",                 getter: s => s.hps.toFixed(4)+" hit/s" },
  { id:"basePre",  name:"기본 대미지(보정 전)",      getter: s => s.basePre.toLocaleString("ko-KR") },
  { id:"basePost", name:"기본 대미지(보정 후)",      getter: s => s.basePost.toLocaleString("ko-KR") },
  { id:"dpsValue", name:"최종 DPS",                 getter: s => Math.round(s.dps).toLocaleString("ko-KR") }
];
const LS_KEY = "priest_calc_visible_cards_v1";
function loadVisible(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || CARD_DEFS.map(c=>c.id); }catch{ return CARD_DEFS.map(c=>c.id); } }
function saveVisible(ids){ localStorage.setItem(LS_KEY, JSON.stringify(ids)); }
let visibleCards = loadVisible();

const chips = document.getElementById('cardChips');
const grid  = document.getElementById('kpiGrid');

function renderChips(){
  chips.innerHTML = "";
  CARD_DEFS.forEach(def=>{
    const chip=document.createElement('label'); chip.className="chip";
    const cb=document.createElement('input'); cb.type="checkbox"; cb.checked = visibleCards.includes(def.id);
    cb.addEventListener('change', ()=>{ 
      if(cb.checked){ if(!visibleCards.includes(def.id)) visibleCards.push(def.id); }
      else{ visibleCards = visibleCards.filter(x=>x!==def.id); }
      saveVisible(visibleCards); recalc();
    });
    chip.appendChild(cb);
    chip.append(def.name);
    chips.appendChild(chip);
  });
}
renderChips();

/* --------------------- 메인 계산 --------------------- */
const punch = document.getElementById('punchScore');
const spark = document.querySelector('.spark');

function recalc(){
  // 입력
  const X6=gv('X6'), F8=gv('F8'), M8=gv('M8');
  const AJ31=gv('AJ31'), T25=gv('T25'), rune3=[gv('T22'),gv('T23'),gv('T24')];
  const T37=gv('T37'), T38=gv('T38');
  const T35=gn('T35'), T36=gn('T36'), AB37=gn('AB37');

  // 보석
  const colD=collectGemCol(0), colE=collectGemCol(1), colF=collectGemCol(2), colG=collectGemCol(3);
  const colH=collectGemCol(4), colI=collectGemCol(5), colJ=collectGemCol(6), colK=collectGemCol(7), colL=collectGemCol(8);
  const colM=collectGemCol(10);

  // 뎀증/쿨감 합
  const D35 = sumproductWeights(colD, W_DMG) + (includesCaseInsensitive(M8,'o') ? 1.5 : 0);
  const E35 = sumproductWeights(colE, W_DMG) + (includesCaseInsensitive(M8,'o') ? 1.5 : 0);
  const F35 = sumproductWeights(colF, W_DMG) + (includesCaseInsensitive(M8,'o') ? 1.5 : 0);
  const G35 = sumproductWeights(colG, W_DMG) + (includesCaseInsensitive(M8,'o') ? 1.5 : 0);
  const M35 = sumproductWeights(colM, W_DMG) + (includesCaseInsensitive(M8,'o') ? 1.5 : 0);
  const H35 = sumproductWeights(colH, W_CDR);
  const I35 = sumproductWeights(colI, W_CDR);
  const J35 = sumproductWeights(colJ, W_CDR);
  const K35 = sumproductWeights(colK, W_CDR);
  const L35 = sumproductWeights(colL, W_CDR);

  // T6/T7 개념
  const T6 = D35 + E35;
  const T7 = H35 + I35;

  // 보정
  const AV6 = (F8 === "O") ? 0.05 : 0;                // 헬리오도르
  const AV7 = (rune3.includes("성전")) ? 0.2 : 0;     // 룬 성전 보정

  // 유효 쿨다운
  const reflex = REFLEX_CDR[T38] || 0;
  const baseCDs = Object.values(BASE_COOLDOWNS);
  const effCDs = baseCDs.map(cd => cd * (1 - reflex));
  const avgCd = avg(effCDs);

  // 기본 대미지
  const basePre = (1195 + T35 + T36) + AB37;
  const pct = 1 + (T6/100) + AV7 + AV6;
  const basePost = basePre * pct;

  // HPS & DPS
  const hps = hitsPerSecondFromCooldowns(effCDs, DPS_MODE[AJ31]);
  const dps = CALCULATE_DPS(basePost, effCDs, AJ31);

  // 상단 펀치킹 점수: 최종 DPS 그대로(반올림) 표시 + 화려한 연출
  punch.textContent = Math.round(dps).toLocaleString("ko-KR");
  // confetti sprinkle
  spark.innerHTML = "";
  for(let i=0;i<22;i++){
    const dot = document.createElement('i');
    dot.style.left = (Math.random()*100)+"%";
    dot.style.animationDelay = (Math.random()*2)+"s";
    dot.style.opacity = 0.7 + Math.random()*0.3;
    spark.appendChild(dot);
  }

  // 출력 카드 -> 선택된 것만 렌더
  const snapshot = {D35,E35,F35,G35,M35,H35,I35,J35,K35,L35, AV6,AV7, avgCd, hps, basePre, basePost, dps};
  grid.innerHTML = "";
  CARD_DEFS.filter(c=>visibleCards.includes(c.id)).forEach(def=>{
    const box=document.createElement('div'); box.className="kbox";
    const t=document.createElement('div'); t.className="t"; t.textContent=def.name;
    const v=document.createElement('div'); v.className="v"; v.textContent = def.getter(snapshot);
    box.appendChild(t); box.appendChild(v); grid.appendChild(box);
  });
}

/* 이벤트 바인딩 & 초기화 */
document.querySelectorAll('select,input').forEach(el=>el.addEventListener('change', recalc));
recalc();
</script>
</body>
</html>
