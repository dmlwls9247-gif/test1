<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>예배당 사제 계산기</title>
<style>
/* --- 스타일: 이전 본 그대로 (생략 없이 포함) --- */
:root{--bg:#0a0c12;--bg2:#0d111a;--card:#111624;--text:#eaf2ff;--muted:#9fb0c9;--border:#1b2436;
--accent:#7fb3ff;--accent2:#a07bff;--chip:#0f1422;--chipBorder:#1c2740;
--radius-lg:22px;--radius-md:16px;--radius-sm:12px;
--medal-heal:#9eb5ff;--medal-bronze:#c58a64;--medal-silver:#cfd2da;--medal-gold:#f0c05a;--medal-pope:#a56bff;--medal-god:#ff5577}
*{box-sizing:border-box}body{margin:0;background:
radial-gradient(80% 60% at 80% -10%, rgba(160,123,255,.25), transparent 65%),
radial-gradient(80% 60% at 10% -10%, rgba(127,179,255,.25), transparent 65%),
linear-gradient(180deg,var(--bg),var(--bg2) 60%,var(--bg));color:var(--text);
font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Pretendard,Segoe UI,Roboto}
.wrap{max-width:1180px;margin:28px auto 60px;padding:0 18px}
.hero{position:relative;border-radius:22px;padding:22px 20px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid var(--border);box-shadow:0 10px 40px rgba(0,0,0,.3),inset 0 0 60px rgba(127,179,255,.06);overflow:hidden}
.hero h1{margin:0 0 10px;font-size:18px;color:#f6eab7;font-weight:900;letter-spacing:.6px}
.scoreRow{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.scoreBox{border-radius:18px;padding:14px 16px;border:1px solid var(--border);background:#0f1422;box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
.scoreBox .t{font-size:12px;color:#cfe0ff;margin-bottom:6px}
.score{font-size:34px;font-weight:900;letter-spacing:.2px;line-height:1.1;background:linear-gradient(90deg,#7fb3ff,#a07bff,#73e0a9,#ffd36b,#7fb3ff);
-webkit-background-clip:text;background-clip:text;color:transparent;background-size:300% 100%;animation:shine 7s linear infinite;text-shadow:0 6px 40px rgba(160,123,255,.25)}
@keyframes shine{0%{background-position:0% 0}100%{background-position:100% 0}}
.grade{margin-top:6px;font-weight:800}
.grade[data-grade="힐사제"]{color:var(--medal-heal)}
.grade[data-grade="동메달"]{color:var(--medal-bronze)}
.grade[data-grade="은메달"]{color:var(--medal-silver)}
.grade[data-grade="금메달"]{color:var(--medal-gold)}
.grade[data-grade="교황"]{color:var(--medal-pope)}
.grade[data-grade="신"]{color:var(--medal-god)}
.spark{position:absolute;inset:0;pointer-events:none}
.spark i{position:absolute;width:6px;height:6px;border-radius:50%;background:linear-gradient(180deg,#a07bff,#7fb3ff);opacity:.8;filter:blur(.2px);animation:drop 3.6s infinite ease-in}
@keyframes drop{0%{transform:translateY(-20px) scale(.8);opacity:0}15%{opacity:1}100%{transform:translateY(240px) scale(1.1);opacity:0}}
.grid{display:grid;grid-template-columns:1.05fr .95fr;gap:16px;margin-top:16px}
.card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.015));border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
.card h3{margin:0 0 12px;font-size:16px;color:#cfe0ff}
.row{display:flex;gap:10px;align-items:center;margin:10px 0}
label{min-width:220px;color:#cfe0ff;font-weight:600}
select,input{width:100%;background:var(--chip);border:1px solid var(--chipBorder);color:var(--text);padding:10px 12px;border-radius:14px;outline:none;box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
table{width:100%;border-collapse:separate;border-spacing:0}
thead th{position:sticky;top:0;background:#0f1422;color:#cfe0ff;padding:10px;border-bottom:1px solid var(--border)}
tbody td{padding:8px 10px;border-bottom:1px solid var(--border)}
.kpi{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:14px}
.kbox{background:#0f1422;border:1px solid var(--chipBorder);border-radius:18px;padding:14px}
.kbox .t{color:#9fb0c9;font-size:12px;margin-bottom:6px}.kbox .v{font-size:20px;font-weight:800}
td.slotLabel{color:#9fb0c9;font-size:12px;white-space:nowrap}
@media (max-width:980px){.grid{grid-template-columns:1fr}.scoreRow{grid-template-columns:1fr}.kpi{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<div class="wrap">

  <!-- 점수/등급 + 출력 KPI -->
  <section class="hero">
    <h1>피어싱 펀치킹 점수</h1>
    <div class="scoreRow">
      <div class="scoreBox"><div class="t">핵펀치딜 점수</div><div id="punchScore" class="score">-</div><div id="punchGrade" class="grade">등급: -</div></div>
      <div class="scoreBox"><div class="t">DPS 점수</div><div id="dpsScore" class="score">-</div><div id="dpsGrade" class="grade">등급: -</div></div>
    </div>
    <div id="kpiGrid" class="kpi"></div>
    <div class="spark" aria-hidden="true"></div>
  </section>

  <section class="grid">
    <!-- 펀치킹 자료 수집 -->
    <div class="card">
      <h3>펀치킹 자료 수집</h3>
      <div class="row"><label>레벨업 카드 공격력</label><input id="T35" type="number" value="600"></div>
      <div class="row"><label>타이틀 보유 효과 공격력</label><input id="T36" type="number" value="375"></div>
      <div class="row"><label>무기 기본 공격력</label><input id="Z35" type="number" value="2232"></div>
      <div class="row"><label>무기 각인 공격력</label><input id="Z36" type="number" value="3534"></div>
      <div class="row"><label>엠블렘 공격력 %</label><input id="AF35" type="number" step="0.1" value="41.8"></div>
      <div class="row"><label>목걸이 공격력</label><input id="Z37" type="number" value="467"></div>
      <div class="row"><label>펫 공격력(있을 때만)</label><input id="Z38" type="number" value="0"></div>
      <div class="row"><label>무기 지력 보너스 데미지</label><input id="AF36" type="number" step="0.1" value="1595.5"></div>
      <div class="row"><label>무기 의지 보너스 데미지</label><input id="AF38" type="number" step="0.1" value="708.9"></div>
      <div class="row"><label>펫 공격력</label><input id="AF37" type="number" step="0.1" value="236"></div>

      <div class="row"><label>엠블럼</label>
        <select id="T25">
          <option>현란함</option><option selected>강렬함</option><option>날쌤</option>
          <option>지혜로움</option><option>여신의 권능</option><option>여신의 가호</option>
          <option>냉혹함</option><option>굳건함</option><option>광폭함</option>
        </select>
      </div>

      <div class="row"><label>반사신경</label>
        <select id="T38">
          <option selected>없음</option>
          <option>신속태그 반사신경 1개</option><option>신속태그 반사신경 2개</option><option>신속태그 반사신경 3개</option>
          <option>다른태그 반사신경 1개</option><option>다른태그 반사신경 2개</option><option>다른태그 반사신경 3개</option>
        </select>
      </div>
    </div>

    <!-- 장비 계산기 -->
    <div class="card">
      <h3>장비 계산기</h3>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>부위</th><th>인첸트(O/X)</th><th>톤 이름</th><th>공증</th><th>피증</th><th>부가 효과</th></tr></thead>
          <tbody id="equipBody"></tbody>
          <tfoot><tr><td colspan="3" style="text-align:right;font-weight:700">합계</td>
            <td id="equipTotalAtk" style="font-weight:900">0</td><td id="equipTotalDmg" style="font-weight:900">0</td><td></td></tr></tfoot>
        </table>
      </div>
    </div>
  </section>

  <!-- 보석 옵션 체크 -->
  <section class="card" style="margin-top:16px">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <h3>보석 옵션 체크</h3>
      <label style="display:flex;align-items:center;gap:8px;color:#cfe0ff;font-weight:600">
        헬리오도르 사용
        <select id="HELIODOR_USE" style="width:90px;background:var(--chip);border:1px solid var(--chipBorder);color:var(--text);padding:8px 10px;border-radius:12px">
          <option>O</option><option selected>X</option>
        </select>
      </label>
    </div>
    <div style="overflow:auto;max-height:52vh">
      <table>
        <thead>
          <tr>
            <th>부위</th><th>슬롯</th>
            <th>보조 뎀증</th><th>강타 뎀증</th><th>연타 뎀증</th><th>방해 뎀증</th>
            <th>보조 쿨감</th><th>강타 쿨감</th><th>연타 쿨감</th><th>방해 쿨감</th><th>소환 쿨감</th>
            <th>생존 뎀증</th>
          </tr>
        </thead>
        <tbody id="gemBody"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
/* ---------- 기본 설정/유틸 ---------- */
const CONFIG={
  W_DMG:{1:2.0,2:1.7,3:1.5},
  W_CDR:{1:0.65,2:0.55,3:0.45},
  BASE_COOLDOWNS:{7:40,8:32,9:34,10:28,11:34,12:30,13:26},
  REFLEX_CDR:{
    "없음":0,"신속태그 반사신경 1개":0.10,"신속태그 반사신경 2개":0.20,"신속태그 반사신경 3개":0.30,
    "다른태그 반사신경 1개":0.08,"다른태그 반사신경 2개":0.16,"다른태그 반사신경 3개":0.24
  },
  THRESHOLDS:[
    {name:"신",punch:390000,dps:205000},
    {name:"교황",punch:370000,dps:205000},
    {name:"금메달",punch:350000,dps:190000},
    {name:"은메달",punch:325000,dps:170000},
    {name:"동메달",punch:300000,dps:150000},
    {name:"힐사제",punch:0,dps:0}
  ],
  equipSlots:["무기","목걸이","반지1","반지2","엠블렘","모자","상의","하의","장갑","신발"],
  equipTable:{} // ← runes.json 로드 후 채움
};
const sum=a=>a.reduce((s,v)=>s+(+v||0),0);
const roundup=x=>Math.ceil(x), rounddown=x=>Math.floor(x);

function setKPI(items){const grid=document.getElementById('kpiGrid');grid.innerHTML="";
  items.forEach(([t,v])=>{const b=document.createElement('div');b.className='kbox';
    const tt=document.createElement('div');tt.className='t';tt.textContent=t;
    const vv=document.createElement('div');vv.className='v';vv.textContent=v;
    b.appendChild(tt);b.appendChild(vv);grid.appendChild(b);});}

/* ---------- 보석 옵션 체크 ---------- */
const GEM_PARTS=[{name:"무기",slots:2},{name:"목걸이",slots:2},{name:"반지1",slots:2},{name:"반지2",slots:2},{name:"엠블렘",slots:2},{name:"모자",slots:3},{name:"상의",slots:3},{name:"하의",slots:3},{name:"장갑",slots:3},{name:"신발",slots:3}];
const gemBody=document.getElementById('gemBody');
function make0to3Select(addr){const s=document.createElement('select');[0,1,2,3].forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;s.appendChild(o)});s.value=0;s.dataset.addr=addr;s.addEventListener('input',recalc);return s}
function renderGem(){gemBody.innerHTML="";GEM_PARTS.forEach((p,pi)=>{for(let si=0;si<p.slots;si++){const tr=document.createElement('tr');
  const tdP=document.createElement('td');tdP.textContent=si===0?p.name:"";tr.appendChild(tdP);
  const tdS=document.createElement('td');tdS.className='slotLabel';tdS.textContent=`슬롯 ${si+1}`;tr.appendChild(tdS);
  for(let c=0;c<11;c++){const td=document.createElement('td');td.appendChild(make0to3Select(`gem_${pi}_${si}_${c}`));tr.appendChild(td)}gemBody.appendChild(tr)}});applyGemRules()}
function applyGemRules(){const useHelio=(document.getElementById('HELIODOR_USE').value==="O");
  gemBody.querySelectorAll('[data-addr^="gem_0_0_"]').forEach(sel=>{if(useHelio){sel.value="0";sel.disabled=true}else{sel.disabled=false}})}
document.getElementById('HELIODOR_USE').addEventListener('change',()=>{applyGemRules();recalc()});renderGem();
function collectGemCol(ci){const arr=[];gemBody.querySelectorAll(`select[data-addr$="_${ci}"]`).forEach(s=>arr.push(parseInt(s.value,10)||0));return arr}
function sumproduct(vals,weights){let s=0;for(const v of vals){if(weights[v])s+=weights[v]}return s}

/* ---------- 장비 계산기 ---------- */
const equipBody=document.getElementById('equipBody');
function renderEquip(){
  equipBody.innerHTML="";
  CONFIG.equipSlots.forEach(slot=>{
    const tr=document.createElement('tr');
    const tdSlot=document.createElement('td');tdSlot.textContent=slot;tr.appendChild(tdSlot);
    const tdEn=document.createElement('td');const en=document.createElement('select');["X","O"].forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;en.appendChild(o)});en.value="X";en.className='enchant';en.addEventListener('change',recalc);tdEn.appendChild(en);tr.appendChild(tdEn);
    const tdRune=document.createElement('td');const sel=document.createElement('select');sel.className='rune';
    const options=Object.keys(CONFIG.equipTable[slot]||{"기타 룬":{atk:0,dmg:0,note:""}});options.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;sel.appendChild(o)});sel.addEventListener('change',recalc);tdRune.appendChild(sel);tr.appendChild(tdRune);
    const tdAtk=document.createElement('td');tdAtk.className='atk';tdAtk.textContent='0';tr.appendChild(tdAtk);
    const tdDmg=document.createElement('td');tdDmg.className='dmg';tdDmg.textContent='0';tr.appendChild(tdDmg);
    const tdNote=document.createElement('td');tdNote.className='note';tdNote.textContent='';tr.appendChild(tdNote);
    equipBody.appendChild(tr);
  });
}
function countEnchantO(){let c=0;document.querySelectorAll('#equipBody .enchant').forEach(s=>{if(String(s.value).toUpperCase()==="O")c++});return c}
function hasArmorBreak(){return Array.from(document.querySelectorAll('#equipBody .note')).some(td=> String(td.textContent||"").includes("방어구 파괴"))}
function equipSums(){let atk=0,dmg=0;document.querySelectorAll('#equipBody tr').forEach(tr=>{
  const slot=tr.children[0].textContent;const runeSel=tr.querySelector('.rune').value;
  const rule=(CONFIG.equipTable[slot]||{})[runeSel]||{atk:0,dmg:0,note:""};
  tr.querySelector('.atk').textContent=rule.atk;tr.querySelector('.dmg').textContent=rule.dmg;tr.querySelector('.note').textContent=rule.note||"";
  atk+=+rule.atk||0;dmg+=+rule.dmg||0;});
  document.getElementById('equipTotalAtk').textContent=atk;document.getElementById('equipTotalDmg').textContent=dmg;return {atk,dmg}}

/* ---------- 등급 ---------- */
function computeGrade(punch,dps){for(const t of CONFIG.THRESHOLDS){if(punch>=t.punch||dps>=t.dps)return t.name}return "힐사제"}
function setGrade(el,name){el.textContent=`등급: ${name}`;el.setAttribute('data-grade',name)}

/* 핵펀치딜 공식(엑셀 수식 1:1) */
function computePunchScoreByFormula(ctx){
  const T35=+ctx.T35||0,T36=+ctx.T36||0,Z35=+ctx.Z35||0,Z36=+ctx.Z36||0,Z37=+ctx.Z37||0,Z38=+ctx.Z38||0;
  const AF35=+ctx.AF35||0,AF36=+ctx.AF36||0,AF37=+ctx.AF37||0,AF38=+ctx.AF38||0;
  const Z31=0,AE9=0,AE10=0,AE11=0,AB31=0,AE13=100; // UI 제거된 보정항목 기본값
  const T25=String(ctx.T25||""); const T6=+ctx.T6||0, AV6=+ctx.AV6||0, AV7=+ctx.AV7||0;
  const enchCount=countEnchantO(); const armorBreak=hasArmorBreak();
  const innerBase=(1195+T35+T36)+((Z35+Z36+300)*(1+AF35/100))+(Z37+Z38)+AF36+(AF38*0.5+AF38*0.3)+AF37+(enchCount*100);
  const part1=2*1*rounddown(innerBase*(1+Z31/100));
  const part2=(1+(AE9/100)+AV6+(AB31/100)+(armorBreak?0.1:0));
  const part3=(1+((T25==="강렬함"||T25==="날쌤")?0.09:0)+(AE10/100+AE11/100));
  const part4=(1+(T6/100)+AV7);
  const part5=(AE13/100);
  return roundup(part1*part2*part3*part4*part5);
}

/* ---------- 재계산 ---------- */
function recalc(){
  const equip=equipSums();
  const colD=collectGemCol(0),colE=collectGemCol(1),colF=collectGemCol(2),colG=collectGemCol(3);
  const colH=collectGemCol(4),colI=collectGemCol(5),colJ=collectGemCol(6),colK=collectGemCol(7),colL=collectGemCol(8);
  const colM=collectGemCol(10);
  const D35=sumproduct(colD,CONFIG.W_DMG),E35=sumproduct(colE,CONFIG.W_DMG),F35=sumproduct(colF,CONFIG.W_DMG),G35=sumproduct(colG,CONFIG.W_DMG),M35=sumproduct(colM,CONFIG.W_DMG);
  const totalDmgPct=D35+E35+F35+G35+M35+equip.dmg;
  const reflexSel=document.getElementById('T38').value, reflex=(CONFIG.REFLEX_CDR[reflexSel]||0);
  const effCDs=Object.values(CONFIG.BASE_COOLDOWNS).map(cd=>cd*(1-reflex));
  const hps=effCDs.reduce((acc,cd)=>acc+((1/cd)*(7+3)),0);
  const ctx={T35:val('T35'),T36:val('T36'),Z35:val('Z35'),Z36:val('Z36'),Z37:val('Z37'),Z38:val('Z38'),
    AF35:val('AF35'),AF36:val('AF36'),AF37:val('AF37'),AF38:val('AF38'),T25:document.getElementById('T25').value,
    T6:totalDmgPct,AV6:0,AV7:0};
  const punch=computePunchScoreByFormula(ctx); const dps=Math.round(punch*hps);
  document.getElementById('punchScore').textContent=Number(punch).toLocaleString('ko-KR');
  document.getElementById('dpsScore').textContent=Number(dps).toLocaleString('ko-KR');
  setGrade(document.getElementById('punchGrade'),computeGrade(punch,dps));
  setGrade(document.getElementById('dpsGrade'),computeGrade(punch,dps));
  setKPI([["총 뎀증 합(%)",totalDmgPct.toFixed(2)+" %"],["장비 공증 합",equip.atk.toString()],["장비 피증 합(%)",equip.dmg.toString()],["초당 타수(HPS)",hps.toFixed(4)]]);
  const spark=document.querySelector('.spark');spark.innerHTML="";for(let i=0;i<22;i++){const d=document.createElement('i');d.style.left=(Math.random()*100)+"%";d.style.animationDelay=(Math.random()*2)+"s";d.style.opacity=0.7+Math.random()*0.3;spark.appendChild(d)}
}
function val(id){return parseFloat(document.getElementById(id).value)||0}
document.querySelectorAll('input,select').forEach(el=>{el.addEventListener('input',recalc);el.addEventListener('change',recalc)});

/* ---------- 데이터 로드: runes.json ---------- */
async function loadRunes(){
  try{
    const res=await fetch('./runes.json',{cache:'no-store'});
    if(!res.ok) throw new Error(res.statusText);
    const tbl=await res.json();
    CONFIG.equipTable=tbl;
  }catch(e){
    // 안전용 최소값(파일 미존재 시)
    CONFIG.equipTable={
      "무기":{"공증/천 자루 검":{atk:24,dmg:0,note:""},"기타 룬":{atk:0,dmg:0,note:""}},
      "목걸이":{"빛줄기":{atk:0,dmg:0,note:""},"기타 룬":{atk:0,dmg:0,note:""}},
      "반지1":{"성전":{atk:0,dmg:0,note:""}}, "반지2":{"수레바퀴":{atk:0,dmg:0,note:""}},
      "엠블렘":{"지혜로움":{atk:0,dmg:0,note:"쿨타임 -18%"}},
      "모자":{"빗발치는 화염":{atk:0,dmg:0,note:"강타패시브 발동"}},
      "상의":{"타오르는 심장":{atk:0,dmg:12,note:"예열 50초"}},
      "하의":{"마나 격류":{atk:13,dmg:0,note:"궁 사용시 스택 초기화"}},
      "장갑":{"신성한 수양":{atk:12,dmg:0,note:"회복량 + 12%"}},
      "신발":{"바위 거인":{atk:16,dmg:0,note:"평균가동률 75%~80%"}}
    };
  }
  renderEquip(); // 테이블(옵션) 그리기
  recalc();
}
loadRunes();
</script>
</body>
</html>
